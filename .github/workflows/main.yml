# --- Main execution function (NO LOOP) ---
def main():
    logging.info("="*20)
    logging.info("Starting a new bot run...")
    
    if not TELEGRAM_TOKEN or not TELEGRAM_CHAT_ID:
        logging.error("FATAL: TELEGRAM_TOKEN or TELEGRAM_CHAT_ID not set in environment variables.")
        return

    # Check if this is the first run by seeing if the sent file exists
    is_first_run = not os.path.exists(SENT_FILE)
    if is_first_run:
        logging.info("FIRST RUN DETECTED: The 'sent_posts.txt' file does not exist.")

    sent_posts = load_sent_posts()
    post = get_latest_post()

    if post:
        # On the first run, we always send the latest post to ensure it works.
        if post["title"] not in sent_posts or is_first_run:
            logging.info(f"New post detected or first run. Sending: '{post['title']}'")
            success = send_post(post["title"], post["image_url"], post["description"])
            if success:
                save_sent_post(post["title"])
                logging.info("Post sent and title saved for future reference.")
        else:
            logging.info(f"Post '{post['title']}' already sent. Nothing to do.")
    else:
        logging.warning("Could not retrieve the latest post from the feed.")

    logging.info("Bot run finished.")
    logging.info("="*20)


if __name__ == "__main__":
    main()
